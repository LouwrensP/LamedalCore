<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\dev\lamedal\trunk\lamedalcore\lamedalcore\lib\xml\xml_xdoc.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Xml.Linq;
using HtmlAgilityPack;
using LamedalCore.domain.Attributes;
using LamedalCore.domain.Enumerals;
using LamedalCore.zz;

namespace LamedalCore.lib.XML
{
    [BlueprintRule_Class(enBlueprintClassNetworkType.Node_Action, GroupName = &quot;xDoc&quot;)]
    public sealed class XML_xDoc
    {
        private readonly LamedalCore_ _lamed = LamedalCore_.Instance; // system library

        /// &lt;summary&gt;
        /// Function to  return document of parsed the XML.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xml&quot;&gt;The XML&lt;/param&gt;
        /// &lt;param name=&quot;autoFix&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [automatic fix].&lt;/param&gt;
        /// &lt;returns&gt;
        /// XDocument
        /// &lt;/returns&gt;
        public XDocument Document(string xml, bool autoFix = false)
        {
            if (autoFix) xml =  _lamed.lib.XML.Setup.Fix_XMLErrorRootElements(xml);
             
            try
            {
                var result = XDocument.Parse(xml);
                return result;

            } catch (Exception e)
            {
                Debug.WriteLine(e);
                if (autoFix == false) return Document(xml, true);  // Retry with autofix
                e.zException_Show(&quot;Error in XML: &quot; + xml);
            }
            return null;
        }

        #region Element
        /// &lt;summary&gt;Return a XElement from and HTML string.&lt;/summary&gt;
        /// &lt;param name=&quot;htmlString&quot;&gt;The HTML string.&lt;/param&gt;
        /// &lt;param name=&quot;removeScriptsAndStyle&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [remove class].&lt;/param&gt;
        /// &lt;param name=&quot;nodes2Remove&quot;&gt;The nodes2 remove.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;exception cref=&quot;System.ArgumentNullException&quot;&gt;htmlString&lt;/exception&gt;
        public XElement Element_FromHtmlStr(string htmlString, bool removeScriptsAndStyle = true, params string[] nodes2Remove)
        {
            var nodesList = nodes2Remove.ToList();
            if (removeScriptsAndStyle)
            {
                nodesList.Add(&quot;script&quot;);
                nodesList.Add(&quot;style&quot;);
            }
            var nodesArray = nodesList.ToArray();

            if (htmlString == null) throw new ArgumentNullException(nameof(htmlString));

            var doc = new HtmlDocument();
            doc.OptionOutputAsXml = true;
            doc.OptionFixNestedTags = true;
            doc.LoadHtml(htmlString);

            if (removeScriptsAndStyle)
            {
                doc.DocumentNode.Descendants().Where(n =&gt; n.Name.zIn(nodesArray))
                 .ToList()
                 .ForEach(n =&gt; n.Remove());
            }

            using (var writer = new StringWriter())
            {
                doc.Save(writer);
                using (var reader = new StringReader(writer.ToString()))
                {
                    return XElement.Load(reader);
                }
            }
        }


        /// &lt;summary&gt;
        /// Function to return root XElement from XML document.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlDoc&quot;&gt;The XML document.&lt;/param&gt;
        /// &lt;returns&gt;
        /// XElement
        /// &lt;/returns&gt;
        public XElement Element_Root(XDocument xmlDoc)
        {
            var name = xmlDoc.Root.Name;
            var result = xmlDoc.Element(name);
            return result;
        }


        /// &lt;summary&gt;Root sets the x document element from the XML document.&lt;/summary&gt;
        public XElement Element_RootSet(XDocument xmlDoc, string elementName)
        {
            if (xmlDoc.Root == null)
            {
                var element = new XElement(elementName);
                xmlDoc.Add(element);
                return element;
            }
            var name = xmlDoc.Root.Name;
            var result = xmlDoc.Element(name);
            return result;
        }

        /// &lt;summary&gt;
        /// Root updates the element.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xDoc&quot;&gt;The x document&lt;/param&gt;
        /// &lt;param name=&quot;elementName&quot;&gt;The element name&lt;/param&gt;
        /// &lt;param name=&quot;xElement&quot;&gt;The x element&lt;/param&gt;
        public void Element_RootUpdate(XDocument xDoc, string elementName, XElement xElement)
        {
            xDoc.zxDoc_Element_(elementName).Remove();
            xDoc.zxDoc_Element_Root().Add(xElement);
        }

        /// &lt;summary&gt;
        /// Function to return XElement from XML string.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xml&quot;&gt;The XML.&lt;/param&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element&lt;/param&gt;
        /// &lt;param name=&quot;autoFix&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [automatic fix].&lt;/param&gt;
        /// &lt;returns&gt;
        /// XElement
        /// &lt;/returns&gt;
        public XElement Element_(string xml, string element, bool autoFix = false)
        {
            var xmlDoc = Document(xml, autoFix);
            var result = Element_(xmlDoc, element);
            return result;
        }

        /// &lt;summary&gt;Function to return element string from XML string.&lt;/summary&gt;
        /// &lt;param name=&quot;xml&quot;&gt;The XML.&lt;/param&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element&lt;/param&gt;
        /// &lt;param name=&quot;autoFix&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [automatic fix].&lt;/param&gt;
        /// &lt;returns&gt;
        /// XElement
        /// &lt;/returns&gt;
        public string Element_AsStr(string xml, string element, bool autoFix = false)
        {
            var xElement = Element_(xml, element, autoFix);
            var result = Element_AsStr(xElement);
            return result;
        }

        /// &lt;summary&gt;Function to return element string from XML string.&lt;/summary&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element&lt;/param&gt;
        /// &lt;returns&gt;
        /// XElement
        /// &lt;/returns&gt;
        public string Element_AsStr(XElement element)
        {
            if (element == null) return &quot;&quot;;

            var result = element.Value;
            return result;
        }

        /// &lt;summary&gt;
        /// Function to return XElement of XML document.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlDoc&quot;&gt;The XML document&lt;/param&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element&lt;/param&gt;
        /// &lt;returns&gt;XElement&lt;/returns&gt;
        public XElement Element_(XDocument xmlDoc, string element)
        {
            var rootElement = Element_Root(xmlDoc);
            var result = rootElement.Element(element);
            if (result == null) result = Element_Add(rootElement, element);
            return result;
        }

        /// &lt;summary&gt;
        /// Function to adds the XML element to the root element.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;element&quot;&gt;The root element&lt;/param&gt;
        /// &lt;param name=&quot;elementValue&quot;&gt;The element&lt;/param&gt;
        /// &lt;returns&gt;
        /// XElement
        /// &lt;/returns&gt;
        public XElement Element_Add(XElement element, string elementValue)
        {
            if (element == null)
            {
                &quot;Error! Can not add element value to undefined element!&quot;.zException_Show();
                return null;
            }
            var result = new XElement(elementValue);
            element.Add(result);
            return result;
        }

        /// &lt;summary&gt;
        /// Sets the element value. The value can be added and removed.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;code&quot;&gt;The code&lt;/param&gt;
        /// &lt;param name=&quot;newValue&quot;&gt;The new value&lt;/param&gt;
        /// &lt;param name=&quot;addValue&quot;&gt;Add value indicator. if [true] then value is added; else value is removed. Default value = true.&lt;/param&gt;
        public void Element_Set(XElement code, string newValue, bool addValue = true)
        {
            if (newValue == &quot;&quot;) return;

            if (newValue.EndsWith(&quot;;&quot;) == false) newValue += &quot;;&quot;;
            var codeValue = code.zxDoc_Element_AsStr();
            var update = false;
            if (addValue)
            {
                //Checked
                if (codeValue.Contains(newValue) == false) codeValue += newValue;
                update = true;
            } else
            {
                // Not Checked
                if (codeValue.Contains(newValue) == true) codeValue = codeValue.Replace(newValue, &quot;&quot;);
                update = true;
            }
            if (update)
            {
                codeValue = codeValue.Trim();
                code.SetValue(codeValue);
            }
        }

        /// &lt;summary&gt;
        /// Sets the element value. The value can be added and removed.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;code&quot;&gt;The code&lt;/param&gt;
        /// &lt;param name=&quot;addValue&quot;&gt;Add value indicator. if [true] then value is added; else value is removed. Default value = true.&lt;/param&gt;
        /// &lt;param name=&quot;newValues&quot;&gt;The new values.&lt;/param&gt;
        public void Element_Set(XElement code, bool addValue = true, params string[] newValues)
        {
            foreach (var value in newValues) Element_Set(code, value, addValue);
        }

        /// &lt;summary&gt;
        /// Function to return XElement of XElement element.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xElement&quot;&gt;The XML element&lt;/param&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element&lt;/param&gt;
        /// &lt;returns&gt;XElement&lt;/returns&gt;
        public XElement Element_(XElement xElement, string element)
        {
            var result = xElement.Element(element);
            if (result == null) result = Element_Add(xElement, element);
            return result;
        }
        #endregion


        #region Attribute
        /// &lt;summary&gt;
        /// Function to return attribute string from XML element.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;The attribute&lt;/param&gt;
        /// &lt;returns&gt;
        /// XAttribute
        /// &lt;/returns&gt;
        public string Attribute_AsStr(XAttribute attribute)
        {
            if (attribute == null) return &quot;&quot;;
            var result = attribute.Value;
            return result;
        }

        /// &lt;summary&gt;
        /// Function to return attribute string from XML element.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlElement&quot;&gt;The XML element&lt;/param&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;The attribute&lt;/param&gt;
        /// &lt;returns&gt;XAttribute&lt;/returns&gt;
        public string Attribute_AsStr(XElement xmlElement, string attribute)
        {
            if (xmlElement == null) return &quot;&quot;;
            var attribute1 = xmlElement.Attribute(attribute);
            var result = Attribute_AsStr(attribute1);
            return result;
        }

        /// &lt;summary&gt;
        /// Function to return attribute from XML element.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlElement&quot;&gt;The XML element&lt;/param&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;The attribute&lt;/param&gt;
        /// &lt;param name=&quot;autoAdd&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [automatic add].&lt;/param&gt;
        /// &lt;returns&gt;
        /// XAttribute
        /// &lt;/returns&gt;
        public XAttribute Attribute_(XElement xmlElement, string attribute, bool autoAdd = true)
        {
            var result = xmlElement.Attribute(attribute);
            if (result == null &amp;&amp; autoAdd)
            {
                // The attribute does not exist -&gt; lets add it.
                result = new XAttribute(attribute, &quot;&quot;);
                xmlElement.Add(result);
            }
            return result;
        }


        /// &lt;summary&gt;
        /// Function to return attribute from XML element in XML document.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlDoc&quot;&gt;The XML document&lt;/param&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element&lt;/param&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;The attribute&lt;/param&gt;
        /// &lt;returns&gt;XAttribute&lt;/returns&gt;
        public XAttribute Attribute_(XDocument xmlDoc, string element, string attribute)
        {
            var xmlElement = Element_(xmlDoc, element);
            return Attribute_(xmlElement, attribute);
        }

        /// &lt;summary&gt;
        /// Function to return attribute from XML element in XML document.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xml&quot;&gt;The XML&lt;/param&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element&lt;/param&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;The attribute&lt;/param&gt;
        /// &lt;param name=&quot;autoFix&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [automatic fix].&lt;/param&gt;
        /// &lt;returns&gt;
        /// XAttribute
        /// &lt;/returns&gt;
        public XAttribute Attribute_(string xml, string element, string attribute, bool autoFix = false)
        {
            var xmlDoc = Document(xml, autoFix);
            var result = Attribute_(xmlDoc, element, attribute);
            return result;
        }

        /// &lt;summary&gt;
        /// Sets the attribute.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element&lt;/param&gt;
        /// &lt;param name=&quot;attributeName&quot;&gt;The attribute name&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value&lt;/param&gt;
        public void Attribute_Set(XElement element, string attributeName, string value)
        {
            if (value != null)
            {
                if (value == &quot;&quot;)
                {
                    var xAttribute = Attribute_(element, attributeName, false);
                    if (xAttribute == null) return;
                    xAttribute.Remove();
                } else
                {
                    var xDefaultType = Attribute_(element, attributeName);
                    xDefaultType.SetValue(value);
                }
            }
        }
        #endregion


        #region xmlList_

        /// &lt;summary&gt;
        /// Function to return list of XML elements from the XML document.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlDoc&quot;&gt;The XML document&lt;/param&gt;
        /// &lt;returns&gt;List&lt;XElement/&gt;&lt;/returns&gt;
        public List&lt;XElement&gt; List_Elements(XDocument xmlDoc)
        {
            var result = xmlDoc.Elements().ToList();
            return result;
        }

        /// &lt;summary&gt;
        /// Function to return list of XML attributes from the XML element.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xmlElement&quot;&gt;The XML element&lt;/param&gt;
        /// &lt;returns&gt;List&lt;XAttribute/&gt;&lt;/returns&gt;
        public List&lt;XAttribute&gt; List_Attributes(XElement xmlElement)
        {
            var result = xmlElement.Attributes().ToList();
            return result;
        }
        #endregion



    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[29,26,29,84,0],[36,15,36,34,0],[37,13,37,14,0],[38,17,38,36,0],[39,17,39,38,0],[39,39,39,66,0],[40,17,40,59,0],[41,13,41,14,0],[42,13,42,25,0],[62,37,62,89,0],[111,13,111,41,0],[112,13,112,47,0],[113,13,113,27,0],[123,9,123,10,0],[124,13,124,55,0],[125,13,125,53,0],[126,9,126,10,0],[138,9,138,10,0],[139,13,139,49,0],[140,13,140,52,0],[141,13,141,27,0],[142,9,142,10,0],[152,9,152,10,0],[153,13,153,60,0],[154,13,154,50,0],[155,13,155,27,0],[156,9,156,10,0],[165,34,165,44,0],[196,13,196,14,0],[197,17,197,92,0],[198,17,198,29,0],[213,33,213,40,0],[226,59,226,103,0],[243,9,243,10,0],[244,13,244,20,0],[244,35,244,44,0],[244,22,244,31,0],[244,46,244,81,0],[244,32,244,34,0],[245,9,245,10,0],[256,33,256,73,0],[285,37,285,47,0],[321,9,321,10,0],[322,13,322,56,0],[323,13,323,54,0],[324,9,324,10,0],[337,9,337,10,0],[338,13,338,49,0],[339,13,339,65,0],[340,13,340,27,0],[341,9,341,10,0],[354,17,354,18,0],[355,21,355,80,0],[356,21,356,44,0],[356,45,356,52,0],[357,21,357,41,0],[358,17,358,18,0],[376,9,376,10,0],[377,13,377,53,0],[378,13,378,27,0],[379,9,379,10,0],[387,9,387,10,0],[388,13,388,59,0],[389,13,389,27,0],[390,9,390,10,0],[28,9,28,10,1],[29,13,29,25,1],[32,13,32,14,1],[33,17,33,51,1],[34,17,34,31,1],[43,9,43,10,1],[53,9,53,10,1],[54,13,54,51,1],[55,13,55,39,1],[56,13,56,14,1],[57,17,57,41,1],[58,17,58,40,1],[59,13,59,14,1],[60,13,60,50,1],[62,13,62,36,1],[64,13,64,42,1],[65,13,65,42,1],[66,13,66,44,1],[67,13,67,38,1],[69,13,69,39,1],[70,13,70,14,1],[71,17,71,59,1],[71,81,73,32,1],[73,42,73,44,1],[74,13,74,14,1],[76,20,76,51,1],[77,13,77,14,1],[78,17,78,34,1],[79,24,79,72,1],[80,17,80,18,1],[81,21,81,50,1],[84,9,84,10,1],[95,9,95,10,1],[96,13,96,41,1],[97,13,97,47,1],[98,13,98,27,1],[99,9,99,10,1],[104,9,104,10,1],[105,13,105,37,1],[106,13,106,14,1],[107,17,107,57,1],[108,17,108,37,1],[109,17,109,32,1],[114,9,114,10,1],[164,9,164,10,1],[165,13,165,33,1],[167,13,167,40,1],[168,13,168,27,1],[169,9,169,10,1],[178,9,178,10,1],[179,13,179,52,1],[180,13,180,55,1],[181,13,181,32,1],[181,33,181,76,1],[182,13,182,27,1],[183,9,183,10,1],[194,9,194,10,1],[195,13,195,33,1],[200,13,200,53,1],[201,13,201,33,1],[202,13,202,27,1],[203,9,203,10,1],[212,9,212,10,1],[213,13,213,32,1],[215,13,215,49,1],[215,50,215,66,1],[216,13,216,56,1],[217,13,217,32,1],[218,13,218,26,1],[219,13,219,14,1],[221,17,221,59,1],[221,60,221,82,1],[222,17,222,31,1],[223,13,223,14,1],[224,13,224,14,1],[226,17,226,58,1],[227,17,227,31,1],[228,13,228,14,1],[229,13,229,24,1],[230,13,230,14,1],[231,17,231,46,1],[232,17,232,42,1],[233,13,233,14,1],[234,9,234,10,1],[254,9,254,10,1],[255,13,255,52,1],[256,13,256,32,1],[257,13,257,27,1],[258,9,258,10,1],[271,9,271,10,1],[272,13,272,35,1],[272,36,272,46,1],[273,13,273,42,1],[274,13,274,27,1],[275,9,275,10,1],[284,9,284,10,1],[285,13,285,36,1],[286,13,286,62,1],[287,13,287,54,1],[288,13,288,27,1],[289,9,289,10,1],[301,9,301,10,1],[302,13,302,58,1],[303,13,303,43,1],[304,13,304,14,1],[306,17,306,56,1],[307,17,307,40,1],[308,13,308,14,1],[309,13,309,27,1],[310,9,310,10,1],[350,9,350,10,1],[351,13,351,31,1],[352,13,352,14,1],[353,17,353,33,1],[359,17,359,18,1],[360,21,360,75,1],[361,21,361,50,1],[362,17,362,18,1],[363,13,363,14,1],[364,9,364,10,1],[17,9,17,70,1],[71,59,71,81,1],[73,32,73,42,1]]);
    </script>
  </body>
</html>