<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\dev\lamedal\trunk\lamedalcore\lamedalcore\lib\xml\xml_setup.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Text.RegularExpressions;
using System.Xml.Linq;
using System.Net;
using System.Text;
using JetBrains.Annotations;
using LamedalCore.domain.Attributes;
using LamedalCore.domain.Enumerals;
using LamedalCore.zz;

namespace LamedalCore.lib.XML
{
    [BlueprintRule_Class(enBlueprintClassNetworkType.Node_Action)]
    public sealed class XML_Setup
    {
        private readonly LamedalCore_ _lamed = LamedalCore_.Instance; // system library

        /// &lt;summary&gt;Converts the input string to valid XML by replacing illegal characters with their XML codes.&lt;/summary&gt;
        /// &lt;param name=&quot;inputStr&quot;&gt;The input string&lt;/param&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        [Pure]
        public string Fix_InvalidXML(string inputStr)
        {
            if (inputStr.zIsNullOrEmpty()) return &quot;&quot;;  // Return empty string 

            if (inputStr.Substring(0, 1) != &quot;&lt;&quot;)
            {
                inputStr = inputStr.Replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)
                    .Replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)
                    .Replace(&quot;\&quot;&quot;, &quot;&amp;quot;&quot;)
                    .Replace(&quot;&#39;&quot;, &quot;&amp;apos;&quot;);
            // Do not do this replace .Replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)
            }

            string result = Regex.Replace(inputStr, @&quot;value=\&quot;&quot;(.*?)\&quot;&quot;&quot;, m =&gt; &quot;value=\&quot;&quot; +
                                  WebUtility.HtmlEncode(WebUtility.HtmlDecode(m.Groups[1].Value)) + &quot;\&quot;&quot;);
            result = result.Replace(&quot;\\&quot;, &quot;/&quot;)
                .Replace(&quot;&lt;!doctype&quot;, &quot;&lt;!DOCTYPE&quot;)
                .Replace(&quot;&lt;/doctype&quot;, &quot;&lt;/DOCTYPE&quot;); // Convert backslash \ to forward slash/
            return result;
        }

        /// &lt;summary&gt;
        /// Function to fix XML  document from the XML.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xml&quot;&gt;The XML&lt;/param&gt;
        /// &lt;param name=&quot;root&quot;&gt;The root.&lt;/param&gt;
        /// &lt;returns&gt;
        /// string
        /// &lt;/returns&gt;
        public string Fix_XMLErrorRootElements(string xml, string root = &quot;doc&quot;)
        {
            var doFix = false;
            
            // Null comment
            if (xml == null) return &quot;&lt;{0}&gt;&lt;/{0}&gt;&quot;.zFormat(root);

            // Remove comments
            if (xml.Contains(&quot;///&quot;))
            {
                xml = xml.Replace(&quot;///&quot;, &quot;&quot;);
                doFix = true;
            }
            else
            {
                // Test for root node
                var root1 = xml.zvar_Id(&quot;&gt;&quot;);
                var rootend = root1.Replace(&quot;&lt;&quot;, &quot;&lt;/&quot;) + &quot;&gt;&quot;;
                var rootend2 = xml.zSubStr_Right(root1.Length);
                if (rootend != rootend2) doFix = true;
            }

            if (doFix) xml = &quot;&lt;doc&gt;&quot;.NL() + xml.NL() + &quot;&lt;/doc&gt;&quot;;
            return xml;
        }

        /// &lt;summary&gt;Formats XML into a structure&lt;/summary&gt;
        /// &lt;param name=&quot;unformatedXML&quot;&gt;The unformated XML.&lt;/param&gt;
        /// &lt;param name=&quot;convert2ValidXMLFirst&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [convert2 valid XML first].&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string XML_Format(string unformatedXML, bool convert2ValidXMLFirst = false)
        {
            string result = null;
            if (convert2ValidXMLFirst) unformatedXML = Fix_InvalidXML(unformatedXML);
            try
            {
                var xElement = XElement.Parse(unformatedXML);
                result = XML_Format(xElement);
            }
            catch (Exception ex)
            {
                ex.zException_Show();
            }
            return result;
        }

        /// &lt;summary&gt;Formats XML into a structure&lt;/summary&gt;
        /// &lt;param name=&quot;unformatedHTML&quot;&gt;The unformated HTML.&lt;/param&gt;
        /// &lt;param name=&quot;element&quot;&gt;The element.&lt;/param&gt;
        /// &lt;param name=&quot;removeScriptsAndStyle&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [remove scripts and style].&lt;/param&gt;
        /// &lt;param name=&quot;nodes2Remove&quot;&gt;The nodes2 remove.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string XML_FormatHTML(string unformatedHTML, out XElement element, bool removeScriptsAndStyle = true, params string[] nodes2Remove)
        {
            element = _lamed.lib.XML.xDoc.Element_FromHtmlStr(unformatedHTML, removeScriptsAndStyle, nodes2Remove);
            var formatedXML = _lamed.lib.XML.Setup.XML_Format(element);
            return formatedXML;
        }

    public string XML_Format(XElement xElement)
        {
            return xElement.ToString();
        }

        /// &lt;summary&gt;
        /// Return the XML elements beteen the tag pattern.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;xml&quot;&gt;The XML&lt;/param&gt;
        /// &lt;param name=&quot;tag&quot;&gt;The node&lt;/param&gt;
        /// &lt;param name=&quot;tagHasAttributes&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [tagHasAttributes].&lt;/param&gt;
        /// &lt;param name=&quot;errorIfTagNotFound&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [error if tag not found].&lt;/param&gt;
        /// &lt;returns&gt;
        /// string
        /// &lt;/returns&gt;
        public string XML_ValueBetweenTags(string xml, string tag, bool tagHasAttributes = false, bool errorIfTagNotFound = true)
        {
            var startTag = (tagHasAttributes) ? &quot;&lt;&quot; + tag + &quot; &quot; : &quot;&lt;&quot; + tag + &quot;&gt;&quot;;
            return XML_ValueBetweenTags(xml, startTag, &quot;&lt;/&quot; + tag + &quot;&gt;&quot;,errorIfTagNotFound);
        }

        /// &lt;summary&gt;
        /// From the input string return the sub-string located between the start and end tags.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;inputStr&quot;&gt;The inputStr.&lt;/param&gt;
        /// &lt;param name=&quot;startTag&quot;&gt;The start tag.&lt;/param&gt;
        /// &lt;param name=&quot;endTag&quot;&gt;The end tag.&lt;/param&gt;
        /// &lt;param name=&quot;errorIfTagNotFound&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [error if tag not found].&lt;/param&gt;
        /// &lt;returns&gt;
        /// string.
        /// &lt;/returns&gt;
        [Pure]
        public string XML_ValueBetweenTags([NotNull] string inputStr, string startTag, string endTag, bool errorIfTagNotFound = true)
        {
            if (inputStr == &quot;&quot;) return &quot;&quot;;
            if (inputStr.Contains(startTag) &amp;&amp; inputStr.Contains(endTag))
            {
                var indexStart = inputStr.IndexOf(startTag) + startTag.Length;
                var indexEnd = inputStr.IndexOf(endTag);
                //return SubStr_ValueBetweenIndexes(inputStr, indexStart, indexEnd - indexStart);
                return _lamed.Types.String.Edit.SubStr_Index(inputStr, indexStart, indexEnd);
            }

            if (errorIfTagNotFound)
            {
                var error = &quot;Error! &#39;{0}&#39; and &#39;{1}&#39; was not found in XML &#39;{2}&#39;&quot;.zFormat(startTag, endTag, inputStr);
                error.zException_Show();
            }
            return &quot;&quot;;
        }

        /// &lt;summary&gt;
        /// Return the XML Attribute value parameterfrom the  XML line.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;attributeLine&quot;&gt;The attribute line&lt;/param&gt;
        /// &lt;param name=&quot;attribute&quot;&gt;The attribute&lt;/param&gt;
        /// &lt;param name=&quot;attributeName&quot;&gt;The attribute name&lt;/param&gt;
        /// &lt;param name=&quot;nameValue&quot;&gt;Return the name value&lt;/param&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public string XML_Attribute(string attributeLine, string attribute, string attributeName, out string nameValue)
        {
            // &lt;param name=&quot;paramLine&quot;&gt;The parameter line.&lt;/param&gt;
            var line = attributeLine.zConvert_XML_ValueBetweenTags(attribute, true);
            nameValue = line.zConvert_XML_ValueBetweenTags(attributeName + &quot;=\&quot;&quot;, &quot;\&quot;&gt;&quot;);
            var result = line.zvar_Value(&quot;\&quot;&gt;&quot;);
            return result;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[90,13,90,33,0],[91,13,91,14,0],[92,17,92,38,0],[93,13,93,14,0],[157,13,157,14,0],[158,13,158,23,0],[35,80,36,105,0],[23,9,23,10,1],[24,13,24,43,1],[24,44,24,54,1],[26,13,26,49,1],[27,13,27,14,1],[28,17,31,45,1],[33,13,33,14,1],[35,13,35,80,1],[36,105,36,107,1],[37,13,39,52,1],[40,13,40,27,1],[41,9,41,10,1],[52,9,52,10,1],[53,13,53,31,1],[56,13,56,29,1],[56,30,56,65,1],[59,13,59,37,1],[60,13,60,14,1],[61,17,61,46,1],[62,17,62,30,1],[63,13,63,14,1],[65,13,65,14,1],[67,17,67,46,1],[68,17,68,62,1],[69,17,69,64,1],[70,17,70,41,1],[70,42,70,55,1],[71,13,71,14,1],[73,13,73,23,1],[73,24,73,65,1],[74,13,74,24,1],[75,9,75,10,1],[82,9,82,10,1],[83,13,83,34,1],[84,13,84,39,1],[84,40,84,86,1],[86,13,86,14,1],[87,17,87,62,1],[88,17,88,47,1],[89,13,89,14,1],[94,13,94,27,1],[95,9,95,10,1],[104,9,104,10,1],[105,13,105,116,1],[106,13,106,72,1],[107,13,107,32,1],[108,9,108,10,1],[111,9,111,10,1],[112,13,112,40,1],[113,9,113,10,1],[126,9,126,10,1],[127,13,127,83,1],[128,13,128,93,1],[129,9,129,10,1],[143,9,143,10,1],[144,13,144,32,1],[144,33,144,43,1],[145,13,145,74,1],[146,13,146,14,1],[147,17,147,79,1],[148,17,148,57,1],[150,17,150,94,1],[153,13,153,36,1],[154,13,154,14,1],[155,17,155,117,1],[156,17,156,41,1],[159,9,159,10,1],[170,9,170,10,1],[172,13,172,85,1],[173,13,173,90,1],[174,13,174,49,1],[175,13,175,27,1],[176,9,176,10,1],[16,9,16,70,1]]);
    </script>
  </body>
</html>