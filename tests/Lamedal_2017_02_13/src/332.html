<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\dev\lamedal\trunk\lamedalcore\lamedalcore\lib\io\io_json.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections;
using System.Collections.Generic;
using System.Reflection;
using LamedalCore.zz;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace LamedalCore.lib.IO
{
    public sealed class IO_Json
    {
        private readonly LamedalCore_ _lamed = LamedalCore_.Instance;

        /// &lt;summary&gt;Converts the class object to json string.&lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;classObject&quot;&gt;The class object. It must be of the original type&lt;/param&gt;
        /// &lt;param name=&quot;DoReferences&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [do references].&lt;/param&gt;
        /// &lt;param name=&quot;filterFields&quot;&gt;The filter fields.&lt;/param&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public string Convert_FromObject&lt;T&gt;(T classObject, bool DoReferences = false, params string[] filterFields)
        {
            if (classObject == null) return string.Empty;

            // Settings
            var settings = new JsonSerializerSettings();
            if (DoReferences) settings.ReferenceLoopHandling = ReferenceLoopHandling.Serialize;
            else settings.ReferenceLoopHandling = ReferenceLoopHandling.Ignore;

            // Filter for fields ===================
            IO_Json_ContractResolver&lt;T&gt; contract = null;
            if (filterFields.Length != 0)
            {
                contract = new IO_Json_ContractResolver&lt;T&gt;(filterFields);
                settings.ContractResolver = contract;
            }

            string json = JsonConvert.SerializeObject(classObject, Formatting.Indented, settings);

            // Error handling
            if (contract != null &amp;&amp; contract.AllFieldsWereFound() == false)
            {
                var missed = contract.MissedFields_AsStr();
                ($&quot;Error! The following fields were not found: {missed}&quot;).zException_Show();                        
            }
            return json;
        }

        /// &lt;summary&gt;Creates the object from json string.&lt;/summary&gt;
        /// &lt;param name=&quot;json&quot;&gt;The json&lt;/param&gt;
        /// &lt;returns&gt;T&lt;/returns&gt;
        public T Convert_ToType&lt;T&gt;(string json)
        {
            // Check for bad escape sequance

            var Object = JsonConvert.DeserializeObject&lt;T&gt;(json);
            return Object;
        }

        /// &lt;summary&gt;Clone object type using Json.&lt;/summary&gt;
        /// &lt;param name=&quot;Object&quot;&gt;The objectect&lt;/param&gt;
        /// &lt;returns&gt;T&lt;/returns&gt;
        public T Convert_CloneType&lt;T&gt;(T Object)
        {
            var json = Convert_FromObject(Object);
            var result = Convert_ToType&lt;T&gt;(json);
            return result;
        }

        /// &lt;summary&gt;Determines whether two objects are equal using Json serialisation.&lt;/summary&gt;
        /// &lt;param name=&quot;Object1&quot;&gt;The first object&lt;/param&gt;
        /// &lt;param name=&quot;Object2&quot;&gt;The second object&lt;/param&gt;
        /// &lt;param name=&quot;errorMsg&quot;&gt;The error message&lt;/param&gt;
        /// &lt;returns&gt;bool&lt;/returns&gt;
        public bool Object_IsEqual(object Object1, object Object2, out string errorMsg)
        {
            errorMsg = &quot;&quot;;
            string json1 = Convert_FromObject(Object1);
            string json2 = Convert_FromObject(Object2);

            bool result = (json1 == json2);

            if (result == false)  // Show where the differences are
            {
                var lines1 = json1.zConvert_Str_ToListStr(&quot;&quot;.NL());
                var lines2 = json2.zConvert_Str_ToListStr(&quot;&quot;.NL());

                var result2 = lines1.zIsEqual(lines2, out errorMsg);
            }

            return result;
        }

        /// &lt;summary&gt;Object synchronize from the JSon string.&lt;/summary&gt;
        /// &lt;param name=&quot;Object&quot;&gt;The objectect&lt;/param&gt;
        /// &lt;param name=&quot;jsonStr&quot;&gt;The json string&lt;/param&gt;
        public void Object_Set(object Object, string jsonStr)
        {
            JObject json = JObject.Parse(jsonStr); 
            Object_Set(Object, json);
        }

        /// &lt;summary&gt;Object synchronize from the JSon string.&lt;/summary&gt;
        /// &lt;param name=&quot;Object&quot;&gt;The object.&lt;/param&gt;
        /// &lt;param name=&quot;json&quot;&gt;The json.&lt;/param&gt;
        /// &lt;param name=&quot;showError&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [show error].&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool Object_Set(object Object, JObject json, bool showError = true)
        {
            string name = Object.ToString();
            string objectName = Object_GetName(json);
            foreach (KeyValuePair&lt;string, JToken&gt; item in json)
            {
                string property_orFieldName = item.Key;
                //if (property_orFieldName.zIn(objectName, &quot;Name&quot;)) continue; // &lt;=========================================

                // Search for property
                if (Object_SetProperty(Object, property_orFieldName, item.Value) == false)
                {
                    // Property not found -&gt; lets try to find a field
                    if (Object_SetField(Object, property_orFieldName, item.Value) == false)
                    {
                        if (property_orFieldName.ToLower() == &quot;name&quot;) continue;  // If the class do not have a name -&gt; ignore this

                        if (showError) $&quot;Error! Property / Field &#39;{property_orFieldName}&#39; does not exist in object: &#39;{name}&#39;.&quot;.zException_Show();
                        return false;
                    } 
                }
            }
            return true;
        }

        /// &lt;summary&gt;
        /// Finds the field in the object specified in the json string and update it.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;Object&quot;&gt;The objectect&lt;/param&gt;
        /// &lt;param name=&quot;jsonStr&quot;&gt;The json string&lt;/param&gt;
        /// &lt;param name=&quot;showError&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [show error].&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool Object_SetField(object Object, string jsonStr, bool showError = true)
        {
            JObject json;
            var fieldName = _lamed.lib.IO.Json.Object_GetName(jsonStr, out json);
            var field = _lamed.Types.Class.ClassInfo.Field_Get(Object, fieldName);
            return _lamed.lib.IO.Json.Object_Set(field, json, showError);
        }

        /// &lt;summary&gt;Name of the object from the json string.&lt;/summary&gt;
        /// &lt;param name=&quot;jsonStr&quot;&gt;The json string&lt;/param&gt;
        /// &lt;param name=&quot;json&quot;&gt;Return the json&lt;/param&gt;
        /// &lt;returns&gt;string&lt;/returns&gt;
        public string Object_GetName(string jsonStr, out JObject json)
        {
            json = JObject.Parse(jsonStr);
            var name = Object_GetName(json);
            return name;
        }

        /// &lt;summary&gt;Name of the object from the json.&lt;/summary&gt;
        /// &lt;param name=&quot;json&quot;&gt;The json.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string Object_GetName(JObject json)
        {
            return (string) json[&quot;Name&quot;];
        }

        /// &lt;summary&gt;Sets the property of the object to the json token. Return false if the property was not found&lt;/summary&gt;
        /// &lt;param name=&quot;Object&quot;&gt;The objectect&lt;/param&gt;
        /// &lt;param name=&quot;propertyName&quot;&gt;The propertyerty name&lt;/param&gt;
        /// &lt;param name=&quot;propertyValue&quot;&gt;The propertyerty valueue&lt;/param&gt;
        private bool Object_SetProperty(object Object, string propertyName, JToken propertyValue)
        {
            PropertyInfo propertyInfo = _lamed.Types.Class.ClassInfo.Property_AsPropertyInfo(Object, propertyName);
            if (propertyInfo == null) return false;
            if (propertyName.ToLower() == &quot;name&quot;) return true;  // We will not set name properties
            // ==========================================================================

            Type propertyType = propertyInfo.PropertyType;

            if (propertyInfo.CanWrite == false)
            {
                // property can not be created
                var property = propertyInfo.GetValue(Object);
                if (property is IList)
                {
                    IList listCurrent = _lamed.Types.Object.CastTo&lt;IList&gt;(property);
                    var listCurrent2 = _lamed.Types.List.Convert.IList_2IListT&lt;string&gt;(listCurrent);
                    List&lt;string&gt; listNew = propertyValue.ToObject&lt;List&lt;string&gt;&gt;();
                    listCurrent2.zFrom_IList(listNew);
                }
            }
            else
            {
                var value = propertyValue.ToObject(propertyType);
                propertyInfo.SetValue(Object, value, null);
            }
            return true;
        }

        /// &lt;summary&gt;Sets the property of the object to the json token. Return false if the property was not found&lt;/summary&gt;
        /// &lt;param name=&quot;Object&quot;&gt;The objectect&lt;/param&gt;
        /// &lt;param name=&quot;fieldName&quot;&gt;The propertyerty name&lt;/param&gt;
        /// &lt;param name=&quot;propertyValue&quot;&gt;The propertyerty valueue&lt;/param&gt;
        private bool Object_SetField(object Object, string fieldName, JToken propertyValue)
        {
            var fieldInfo = _lamed.Types.Class.ClassInfo.Field_AsFieldInfo(Object.GetType(), fieldName);
            if (fieldInfo == null) return false;

            Type fieldType = fieldInfo.FieldType;

            var value = propertyValue.ToObject(fieldType);
            fieldInfo.SetValue(Object, value);
            return true;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[23,38,23,58,0],[45,13,45,14,0],[126,25,126,38,0],[175,51,175,63,0],[22,9,22,10,1],[23,13,23,37,1],[26,13,26,57,1],[27,13,27,30,1],[27,31,27,96,1],[28,18,28,80,1],[31,13,31,57,1],[32,13,32,42,1],[33,13,33,14,1],[34,17,34,74,1],[35,17,35,54,1],[36,13,36,14,1],[38,13,38,99,1],[41,13,41,76,1],[42,13,42,14,1],[43,17,43,60,1],[44,17,44,93,1],[46,13,46,25,1],[47,9,47,10,1],[53,9,53,10,1],[56,13,56,65,1],[57,13,57,27,1],[58,9,58,10,1],[64,9,64,10,1],[65,13,65,51,1],[66,13,66,50,1],[67,13,67,27,1],[68,9,68,10,1],[76,9,76,10,1],[77,13,77,27,1],[78,13,78,56,1],[79,13,79,56,1],[81,13,81,44,1],[83,13,83,33,1],[84,13,84,14,1],[85,17,85,68,1],[86,17,86,68,1],[88,17,88,69,1],[89,13,89,14,1],[91,13,91,27,1],[92,9,92,10,1],[98,9,98,10,1],[99,13,99,51,1],[100,13,100,38,1],[101,9,101,10,1],[109,9,109,10,1],[110,13,110,45,1],[111,13,111,54,1],[112,13,112,20,1],[112,59,112,63,1],[112,22,112,55,1],[113,13,113,14,1],[114,17,114,56,1],[118,17,118,91,1],[119,17,119,18,1],[121,21,121,92,1],[122,21,122,22,1],[123,25,123,70,1],[123,71,123,80,1],[125,25,125,39,1],[125,40,125,146,1],[128,17,128,18,1],[129,13,129,14,1],[112,56,112,58,1],[130,13,130,25,1],[131,9,131,10,1],[141,9,141,10,1],[143,13,143,82,1],[144,13,144,83,1],[145,13,145,74,1],[146,9,146,10,1],[153,9,153,10,1],[154,13,154,43,1],[155,13,155,45,1],[156,13,156,25,1],[157,9,157,10,1],[163,9,163,10,1],[164,13,164,42,1],[165,9,165,10,1],[172,9,172,10,1],[173,13,173,116,1],[174,13,174,38,1],[174,39,174,52,1],[175,13,175,50,1],[178,13,178,59,1],[180,13,180,48,1],[181,13,181,14,1],[183,17,183,62,1],[184,17,184,39,1],[185,17,185,18,1],[186,21,186,85,1],[187,21,187,101,1],[188,21,188,83,1],[189,21,189,55,1],[190,17,190,18,1],[191,13,191,14,1],[193,13,193,14,1],[194,17,194,66,1],[195,17,195,60,1],[196,13,196,14,1],[197,13,197,25,1],[198,9,198,10,1],[205,9,205,10,1],[206,13,206,105,1],[207,13,207,35,1],[207,36,207,49,1],[209,13,209,50,1],[211,13,211,59,1],[212,13,212,47,1],[213,13,213,25,1],[214,9,214,10,1],[13,9,13,70,1]]);
    </script>
  </body>
</html>